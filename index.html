<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Email Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .email-item.active { background-color: #3b82f6; color: white; }
        .email-item.active .text-slate-500 { color: #dbeafe; }
        .chart-container { position: relative; height: 250px; width: 100%; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px;}
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="bg-pink-50 text-slate-800 antialiased">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-900">AI-Powered Email Assistant</h1>
            <p class="text-slate-600 mt-2">Your intelligent command center for customer support.</p>
        </header>

        <!-- Stat Cards Section -->
        <section class="mb-8 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6">
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm text-center">
                <h3 class="text-slate-500 text-sm font-medium">Total Emails (24h)</h3>
                <p id="total-emails" class="text-3xl font-semibold mt-1 text-slate-800">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm text-center">
                <h3 class="text-slate-500 text-sm font-medium">Pending</h3>
                <p id="pending-emails" class="text-3xl font-semibold mt-1 text-amber-600">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm text-center">
                <h3 class="text-slate-500 text-sm font-medium">Resolved</h3>
                <p id="resolved-emails" class="text-3xl font-semibold mt-1 text-green-600">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm text-center">
                <h3 class="text-slate-500 text-sm font-medium">Urgent</h3>
                <p id="urgent-emails" class="text-3xl font-semibold mt-1 text-red-600">0</p>
            </div>
        </section>

        <!-- Analytics Dashboard -->
        <section id="analytics" class="mb-8">
            <h2 class="text-2xl font-semibold text-slate-800 mb-4 text-center">Analytics Dashboard</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6">
                <!-- Status Chart -->
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="font-semibold text-slate-600 text-sm mb-2 text-center">Status Overview</h3>
                    <div class="chart-container"><canvas id="statusChart"></canvas></div>
                </div>
                <!-- Priority Chart -->
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="font-semibold text-slate-600 text-sm mb-2 text-center">Priority Breakdown</h3>
                    <div class="chart-container"><canvas id="priorityChart"></canvas></div>
                </div>
                <!-- Sentiment Chart -->
                <div class="bg-white p-4 rounded-xl border border-slate-200 col-span-1 sm:col-span-2 shadow-sm">
                    <h3 class="font-semibold text-slate-600 text-sm mb-2 text-center">Sentiment Analysis</h3>
                    <div class="chart-container"><canvas id="sentimentChart"></canvas></div>
                </div>
            </div>
        </section>
        
        <!-- Main Content -->
        <main class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Email List -->
            <div class="md:col-span-1 bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Pending Inbox</h2>
                    <button id="fetch-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all duration-300 text-sm font-semibold shadow hover:shadow-md">
                        Fetch Emails
                    </button>
                </div>
                <div id="email-list" class="space-y-2 h-[60vh] overflow-y-auto pr-2">
                    <!-- Emails will be injected here -->
                </div>
            </div>

            <!-- Email Detail & Response -->
            <div class="md:col-span-2">
                <div id="email-detail-view" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hidden">
                    <h2 id="email-subject" class="text-2xl font-bold mb-1"></h2>
                    <p id="email-from" class="text-slate-500 mb-4 text-sm"></p>
                    
                    <div class="bg-slate-50 p-4 rounded-md border border-slate-200 mb-6 h-40 overflow-y-auto">
                        <p id="email-body-content" class="text-slate-700 whitespace-pre-wrap text-sm"></p>
                    </div>

                    <h3 class="text-lg font-semibold mb-3">AI-Generated Response</h3>
                    <textarea id="ai-response" class="w-full p-3 border border-slate-300 rounded-md h-44 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm"></textarea>
                    <button id="send-reply-btn" class="mt-4 w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold shadow hover:shadow-md">Send & Mark Resolved</button>
                </div>
                <div id="placeholder-view" class="h-full flex items-center justify-center bg-white rounded-xl border-2 border-dashed border-slate-300">
                    <p class="text-slate-500">Select an email to view details.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';
        let currentEmailId = null;
        let statusChart, priorityChart, sentimentChart;

        document.addEventListener('DOMContentLoaded', async () => {
            await fetchEmails();
            await fetchAnalytics();
        });

        document.getElementById('fetch-btn').addEventListener('click', () => fetchEmails(true));
        document.getElementById('send-reply-btn').addEventListener('click', sendReply);

        async function fetchEmails(isManual = false) {
            if (isManual) {
                const btn = document.getElementById('fetch-btn');
                btn.innerText = 'Fetching...';
                btn.disabled = true;
                await fetch(`${API_BASE_URL}/fetch-emails/`, { method: 'POST' });
            }

            const response = await fetch(`${API_BASE_URL}/emails/`);
            const emails = await response.json();
            const emailList = document.getElementById('email-list');
            emailList.innerHTML = ''; 

            emails.forEach(email => {
                const div = document.createElement('div');
                div.className = 'email-item p-3 rounded-lg cursor-pointer hover:bg-blue-500 hover:text-white transition-colors duration-200';
                div.dataset.emailId = email.id;

                div.innerHTML = `
                    <p class="font-semibold truncate pr-2 text-sm">${email.subject}</p>
                    <p class="text-sm text-slate-500 truncate">${email.sender}</p>
                `;
                if (email.priority === 'Urgent') {
                    div.classList.add('border-l-4', 'border-red-500');
                }
                
                div.addEventListener('click', () => {
                    document.querySelectorAll('.email-item').forEach(item => item.classList.remove('active'));
                    div.classList.add('active');
                    displayEmailDetail(email);
                });
                emailList.appendChild(div);
            });
            
            if (isManual) {
                const btn = document.getElementById('fetch-btn');
                btn.innerText = 'Fetch New Emails';
                btn.disabled = false;
                fetchAnalytics();
            }
        }

        async function fetchAnalytics() {
            try {
                const response = await fetch(`${API_BASE_URL}/analytics`);
                if (!response.ok) return;
                const data = await response.json();
                
                // Update Stat Cards
                document.getElementById('total-emails').innerText = data.total ?? 0;
                document.getElementById('pending-emails').innerText = data.pending ?? 0;
                document.getElementById('resolved-emails').innerText = data.resolved ?? 0;
                document.getElementById('urgent-emails').innerText = data.urgent ?? 0;

                // Update Charts
                renderCharts(data);
            } catch (error) {
                console.error("Error fetching analytics:", error);
            }
        }

        function displayEmailDetail(email) {
            currentEmailId = email.id;
            document.getElementById('placeholder-view').classList.add('hidden');
            document.getElementById('email-detail-view').classList.remove('hidden');

            document.getElementById('email-subject').innerText = email.subject;
            document.getElementById('email-from').innerText = `From: ${email.sender} | Priority: ${email.priority}`;
            document.getElementById('email-body-content').innerText = email.body; 

            document.getElementById('ai-response').value = 'Generating response, please wait...';
            document.getElementById('send-reply-btn').disabled = true;

            generateResponse(email.id);
        }

        async function generateResponse(emailId) {
            const response = await fetch(`${API_BASE_URL}/emails/${emailId}/generate-response`, { method: 'POST' });
            const data = await response.json();
            document.getElementById('ai-response').value = data.draft_reply;
            document.getElementById('send-reply-btn').disabled = false;
        }

        async function sendReply() {
            const replyText = document.getElementById('ai-response').value;
            if (!currentEmailId || !replyText) return;
            
            const sendButton = document.getElementById('send-reply-btn');
            sendButton.innerText = 'Sending...';
            sendButton.disabled = true;

            await fetch(`${API_BASE_URL}/emails/${currentEmailId}/send`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reply_text: replyText })
            });

            sendButton.innerText = 'Send & Mark Resolved';
            document.getElementById('email-detail-view').classList.add('hidden');
            document.getElementById('placeholder-view').classList.remove('hidden');
            
            await fetchEmails(false);
            await fetchAnalytics();
        }

        function renderCharts(data) {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 12, padding: 15 } } }
            };

             // Status Chart (Doughnut)
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            const statusData = {
                labels: ['Resolved', 'Pending'],
                datasets: [{
                    data: [data.resolved ?? 0, data.pending ?? 0],
                    backgroundColor: ['#22c55e', '#f59e0b'],
                    borderColor: '#ffffff',
                    borderWidth: 2,
                }]
            };
            if (statusChart) statusChart.destroy();
            statusChart = new Chart(statusCtx, { type: 'doughnut', data: statusData, options: commonOptions });

            // Priority Chart (Pie)
            const priorityCtx = document.getElementById('priorityChart').getContext('2d');
            const notUrgent = (data.pending ?? 0) - (data.urgent ?? 0);
            const priorityData = {
                labels: ['Urgent', 'Not Urgent'],
                datasets: [{
                    data: [data.urgent ?? 0, notUrgent],
                    backgroundColor: ['#ef4444', '#3b82f6'],
                    borderColor: '#ffffff',
                    borderWidth: 2,
                }]
            };
            if (priorityChart) priorityChart.destroy();
            priorityChart = new Chart(priorityCtx, { type: 'pie', data: priorityData, options: commonOptions });
            
            // Sentiment Chart (Bar)
            const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
            const sentimentCounts = data.sentiment_counts || {};
            const sentimentData = {
                labels: ['Positive', 'Negative', 'Neutral'],
                datasets: [{
                    label: 'Sentiment Count',
                    data: [sentimentCounts.Positive ?? 0, sentimentCounts.Negative ?? 0, sentimentCounts.Neutral ?? 0],
                    backgroundColor: ['rgba(34, 197, 94, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(245, 159, 11, 0.7)'],
                    borderColor: ['#22c55e', '#ef4444', '#f59e0b'],
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            };
            if (sentimentChart) sentimentChart.destroy();
            sentimentChart = new Chart(sentimentCtx, { type: 'bar', data: sentimentData, options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
            }});
        }
    </script>
</body>
</html>


